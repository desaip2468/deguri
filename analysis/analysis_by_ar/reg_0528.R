data<-read.csv("C:/Users/user/Desktop/2019-1/DATA/EMBRAIN/data_for_modeling5.csv")
data<-data[ , -c(36:232)] #???????????? ?????? usagetime ????????? ?????????????????????
data1<-read.csv("payments_ppdb_app_g2_company_code_aggregated_cp949.csv")

library(tidyverse)
#?????? aggregated data + google ?????? ????????? +real_price

hi<-data.frame(data1$panel_id, data1%>%dplyr::select(ends_with("usagetime")), data1%>%select(starts_with("approval_real_price_sum_by_by_approval_type"))) #???????????? usagetime ????????? real price ???????????????

colnames(hi)[1] <-"panel_id" #????????? ???????????? ???????????? ?????? ???????????????


data$panel_id<-as.character(data$panel_id)
hi$panel_id<-as.character(hi$panel_id)

data2<-full_join(data,hi, by="panel_id")


#5060 user ??????

old<-data2%>%filter(data$age>=50) #50??? ????????? ??????
user<-old%>%filter(approval_real_price_sum_by_by_approval_type_LT01>0) #user??? ??????


#outlier ?????? (???????????? ????????? ?????? ?????? 3??? ??? ??????)

sorted <- user[c(order(user$approval_real_price_sum_by_by_approval_type_LT01, decreasing = TRUE)),] 

user<- sorted[-c(1,2,3), ] #?????? 3??? ??????????????? ?????? 

user<-user[ , -1] #??? ????????? ??? ?????? ???????????? ??????????????? ??????????????????




colnames(user)
attach(user)

plot(user.age, approval_real_price_sum_by_by_approval_type_LT01)
lm<-lm(approval_real_price_sum_by_by_approval_type_LT01~user.age)
bc_norm <- MASS::boxcox(lm)
lambda <- bc_norm$x[which.max(bc_norm$y)]
lm.boxcox<-lm(approval_real_price_sum_by_by_approval_type_LT01^lambda~user.age)
summary(lm.boxcox)
plot(lm.boxcox)       


target<-approval_real_price_sum_by_by_approval_type_LT01

#category

category<-cbind(approval_real_price_sum_by_by_approval_type_LT01, category)
lm<-lm(approval_real_price_sum_by_by_approval_type_LT01~., data=category)
vif(lm)


# ?????? ?????? (company)
colnames(company) 
lm<-lm(target~user.bksum+user.cdsum+user.cusum+user.sesum+user.sbsum, data=company)
summary(lm)

#???????????? ??????: bksum(????????????+?????? ?????????), cdsum (????????????)
#?????? ??????????????? ???????????? ???????????????


# payment type
paymenttype<-data1%>%filter(age>=50 & approval_real_price_sum_by_by_approval_type_LT01>0)%>%select(starts_with("card_payment_type"), approval_real_price_sum_by_by_approval_type_LT01)
sorted <- paymenttype[c(order(paymenttype$approval_real_price_sum_by_by_approval_type_LT01, decreasing = TRUE)),] 
paymenttype<- sorted[-c(1,2,3), ] #?????? 3??? ??????????????? ?????? 
lm<-lm(approval_real_price_sum_by_by_approval_type_LT01~card_payment_type_PCK_count+card_payment_type_PCT_count, data=paymenttype)
summary(lm)
vif(lm)


# ???????????? ??????:  pbk count(?????? ????????? ?????? ??????)
# pbk??? ???????????? ?????? ???????????? ????????? ??????-> pbk+pck ??????????????? 
check<-paymenttype$card_payment_type_PBK_count+paymenttype$card_payment_type_PCK_count
check<-cbind(paymenttype,check)
summary(lm(approval_real_price_sum_by_by_approval_type_LT01~check+card_payment_type_PCK_count, data=check))

# ????????????(PBK+PCT) + ???????????? ??????(PCK) ?????? ?????????????????? -> ?????????????????? ???????????? ?????? ???????????? ????????? ???????????? 
#????????? ???????????? ????????? ???????????? ????????? ?????? ??????????????????, ?????? ?????? ?????? ????????? ??? ??? ?????? ???????????? ?????? ????????? ????????? ??????????????? ?????? ?????? ?????? ??? ?????????
# ????????? ???????????? ????????? ???????????? ???????????? 1. nonuser??? user??? ????????? ?????? 2. ?????? ????????? ?????? ???????????? ?????????????????? ?????? ?????? ?????? ??? ??????????????? 
#1?????? ??????, ?????? ?????? ?????? ???????????? ?????? ?????? ??????
#2???, ?????????, ?????? ??? ?????? ?????? ????????? ?????? ???????????? ????????? ????????? ?????? ?????? 


# app usage time

usagetime<-user%>%select(ends_with("usagetime"))
colnames(usagetime)<-c("??????_usagetime",	"?????????_usagetime",	"??????????????????_usagetime",	"N_usagetime"	,"?????? ??? ????????????_usagetime",	
                          "??????/????????????_usagetime"	,"??????????????????_usagetime",	"??????/???????????????_usagetime",	"????????? ????????????/?????????_usagetime"	,
                          "??????_usagetime",	"??????????????????_usagetime",	"??????_usagetime",	"??????_usagetime",	"??????/?????????_usagetime",	"????????????_usagetime",	
                          "??????/??????_usagetime",	"??????_usagetime",	"??????_usagetime",	"??????_usagetime",	"??????/??????_usagetime",	"??????_usagetime",	
                          "??????_usagetime",	"??????_usagetime",	"?????????_usagetime",	"????????????_usagetime",	"??????_usagetime",	"??????/?????????_usagetime"	,
                          "??????_usagetime",	"??????_usagetime",	"?????? ??????_usagetime",	"?????????_usagetime",	"????????? ??????_usagetime",	"?????????_usagetime",
                          "????????????_usagetime",	"?????????/??? ????????????_usagetime",	"???????????????_usagetime",	"??????/??????_usagetime",	"????????????_usagetime",	
                          "?????????_usagetime",	"?????????_usagetime",	"??????_usagetime",	"??????_usagetime",	"???????????????/??????_usagetime",	"??????_usagetime",	
                          "??????_usagetime",	"?????????_usagetime",	"????????? ??????_usagetime",	"??????_usagetime")


#?????? ?????? ?????? ?????? 
usagetime<-cbind(target,usagetime)
lm<-lm(target~., data=usagetime)
summary(lm)
plot(lm)
which(summary(lm)$coefficients[,4]<0.05)

#??????????????? - ??????
which(vif(lm)>4)

#??????????????? ?????? ????????? ?????? ?????? 
usagetime_sig<-usagetime%>%select(which(summary(lm)$coefficients[,4]<0.05))
usagetime_sig<-cbind(target, usagetime_sig)
lm<-lm(target~., data=usagetime_sig)
summary(lm) #???????????????...0.07

#forward selection 

lm.null<-lm(target~1, data=usagetime)
lm.full<-lm(target~., data=usagetime)
forward.selection<- step(lm.null, direction = "forward", scope=list(lower=lm.null, upper=lm.full))
summary(forward.selection)
plot(forward.selection)
usagetime[usagetime$target==0,]
par(mfrow=c(1,1))
exptarget<-exp(usagetime$target)
sqrttarget<-sqrt(usagetime$target)
plot(usagetime[2:11],target))

usagetime<-cbind(sqrttarget,usagetime)
usagetime<-usagetime[ , -c(2,3,4)]
lm<-lm(sqrt(sqrttarget)~., data=usagetime)
lm.null<-lm(target~1, data=usagetime)
lm.full<-lm(target~., data=usagetime)
forward.selection<- step(lm.null, direction = "forward", scope=list(lower=lm.null, upper=lm.full))
summary(forward.selection)
plot(forward.selection)


usagetime<-usagetime[,-1]
usagetime<-cbind(target,usagetime)
lm<-lm(target^(1/4)~.,data=usagetime)
summary(lm)
plot(lm)

usa_1<-rowSums(usagetime[2:49])
plot(usagetime$`27`, usagetime$target)
abline(lm(target~usagetime$'27'))                                                                                                                                                                                                 
summary(usagetime$target)

#usagetime??? ?????? ?????? ???????????? ??? ????????? ?????? ->???????????? ???????????? ???????????? ?????? ????????? ?????? ?????? ??? 

# age, gender

a.g<-data1%>%filter(age>=50 & approval_real_price_sum_by_by_approval_type_LT01>0)%>%select(approval_real_price_sum_by_by_approval_type_LT01, age, gender)
a.g$gender<-ifelse(a.g$gender==2,0,1)
lm<-lm(approval_real_price_sum_by_by_approval_type_LT01^(1/4)~age, data=a.g)
summary(lm)
plot(lm)


